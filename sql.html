<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WTJXDSS7');</script>
    <!-- End Google Tag Manager -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/main.css">
    <title>Advanced SQL & BigQuery - Jose Bardales</title>
    <style>
        /* --- RESET & BASICS --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* THEME: Royal Navy Blue */
            background-color: #152039; 
            color: #e0e0e0;
            line-height: 1.8; 
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 300px;
            height: 100vh; 
            position: sticky;
            top: 0;
            overflow-y: auto; 
            /* THEME: Darker Navy */
            background-color: #0d1424;
            padding: 30px 25px; 
            border-right: 1px solid #2c3e50;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            line-height: 1.6;
        }

        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: #0d1424; }
        .sidebar::-webkit-scrollbar-thumb { background: #2c3e50; border-radius: 4px; }

        /* Sidebar Typography */
        .sidebar h1 { font-size: 1.8rem; margin-bottom: 5px; color: #fff; font-weight: 600; }
        .role-title { color: #ffffff; font-size: 1.1rem; font-weight: 500; margin-bottom: 2px; }
        .location-title { color: #a0aec0; font-size: 0.9rem; margin-bottom: 20px; display: block; }
        .sidebar p { margin-bottom: 15px; color: #cfcfcf; font-size: 0.9rem; line-height: 1.5;}
        .sidebar h3 { margin-bottom: 5px; color: #fff; font-weight: 600; font-size: 1.1rem; }

        /* Links */
        a { color: #C0C0C0; text-decoration: none; transition: color 0.3s ease; font-weight: 500; }
        a:hover { color: #ffffff; text-decoration: underline; }

        /* Back Button */
        .back-btn {
            display: block;
            margin-bottom: 20px;
            color: #4fd1c5;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .back-btn:hover { color: #fff; text-decoration: none; }

        /* Visit Counter */
        .visit-counter {
            background-color: #1e2b4a;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-bottom: 20px;
            border: 1px solid #3b4c75;
            text-align: center;
        }
        .counter-number { display: inline-block; margin-left: 5px; font-weight: bold; color: #4fd1c5; }

        /* Certificates */
        .cert-section { margin-top: 5px; margin-bottom: 15px; border-top: 1px solid #2c3e50; padding-top: 15px; }
        .cert-item { margin-bottom: 12px; }
        .cert-title { font-size: 0.95rem; color: #fff; margin-bottom: 2px; line-height: 1.2; font-weight: 600;}
        .cert-issuer { font-size: 0.8rem; color: #8892b0; margin-bottom: 2px; font-style: italic; }
        .cert-link { font-size: 0.8rem; display: inline-block; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex-grow: 1;
            padding: 50px 80px;
            /* THEME: Royal Navy Blue */
            background-color: #152039;
            max-width: 1200px; 
        }

        h1.page-title { font-size: 2.2rem; margin-bottom: 10px; color: #fff; }
        
        /* Header Layout */
        .header-split {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            gap: 40px;
            flex-wrap: wrap-reverse; 
        }

        .header-left { flex: 1; min-width: 300px; }
        .header-right { flex-shrink: 0; }

        /* Header Logo */
        .header-logo {
            width: 180px; 
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.1));
        }

        /* TOC Box */
        .toc-box {
            background-color: #1e2b4a;
            padding: 20px 25px;
            border-radius: 12px;
            border: 1px solid #2c3e50;
            margin-top: 20px;
            display: inline-block;
            width: 100%;
        }
        .toc-box h3 { margin-top: 0; font-size: 1.1rem; color: #C0C0C0; margin-bottom: 10px;}
        .toc-box ul { list-style: none; padding-left: 0; margin: 0; }
        .toc-box li { margin-bottom: 8px; }
        .toc-box a { color: #4fd1c5; }

        /* Article Content */
        section h2 { 
            font-size: 1.5rem; 
            margin-top: 40px; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #2c3e50; 
            padding-bottom: 10px; 
            color: #fff;
        }
        section h3, section h4 { color: #fff; margin-top: 25px; margin-bottom: 10px; }
        
        section p { margin-bottom: 20px; color: #cfcfcf; font-size: 1.05rem; }
        section ol, section ul.list { margin-bottom: 20px; padding-left: 20px; color: #cfcfcf; }
        section li { margin-bottom: 8px; }

        /* --- CODE BLOCK STYLING (NEW) --- */
        .code-block {
            background-color: #0b101d; /* Very dark blue for code */
            border: 1px solid #2c3e50;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.95rem;
            color: #d4d4d4;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .code-keyword { color: #c678dd; font-weight: bold; } /* Purple for SQL keywords */
        .code-func { color: #61afef; } /* Blue for functions */
        .code-string { color: #98c379; } /* Green for strings */
        .code-comment { color: #7f848e; font-style: italic; } /* Grey for comments */

        /* --- MOBILE --- */
        @media (max-width: 768px) {
            .container { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: auto; position: relative; border-right: none; border-bottom: 1px solid #2c3e50; overflow-y: visible; }
            .main-content { padding: 30px 20px; }
            .back-btn { display: none; }
            /* header-split handled centrally in assets/css/main.css */
            .header-logo { width: 120px; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WTJXDSS7"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        
        <!-- LEFT SIDEBAR -->
        <aside class="sidebar">
            <a href="index.html" class="back-btn">&larr; Back to Portfolio</a>

            <h1>Jose F. Bardales</h1>
            <div class="role-title">Senior Data Scientist</div>
            <div class="location-title">Tegucigalpa, Honduras</div>

            <p>Hello! This is a collection of projects I have worked on using SQL, Tableau, and Python.</p>

            <div class="visit-counter">
                Total Portfolio Visits: <span class="counter-number" id="visit-count">0</span>
            </div>

            <h3 style="margin-bottom: 5px;">Contact</h3>
            <p style="margin-bottom: 15px;">
                <a href="mailto:josefbardales@outlook.com" target="_blank">josefbardales@outlook.com</a>
            </p>

            <div class="cert-section">
                <h3 style="margin-bottom: 10px;">Certifications</h3>
                
                <div class="cert-item">
                    <h4 class="cert-title">Google Data Analytics Certificate</h4>
                    <p class="cert-issuer">Granted by: Google</p>
                    <a href="https://www.coursera.org/account/accomplishments/professional-cert/FCPVMXLDTC8P?utm_source=link&utm_medium=certificate&utm_content=cert_image&utm_campaign=sharing_cta" class="cert-link" target="_blank">View Certificate &rarr;</a>
                </div>

                <div class="cert-item">
                    <h4 class="cert-title">Human Talent Management</h4>
                    <p class="cert-issuer">Granted by: UNITEC</p>
                    <a href="https://drive.google.com/file/d/1AyQhJ-RA9tMk2Nan43c7xekk6dTl53rm/view?usp=sharing" class="cert-link" target="_blank">View Certificate &rarr;</a>
                </div>

                <div class="cert-item">
                    <h4 class="cert-title">1st Place, Int. Business Intelligence</h4>
                    <p class="cert-issuer">Granted by: LABSAG</p>
                    <a href="https://drive.google.com/file/d/1fmju_rH4lUeCkAAae4iq-oGTT6EVIlme/view?usp=sharing" class="cert-link" target="_blank">View Certificate &rarr;</a>
                </div>
            </div>

            <h3 style="margin-bottom: 10px; font-size: 1rem;">Social</h3>
            <div style="display: flex; gap: 15px;">
                <a href="https://github.com/Josefbardales/PortfolioCodes" target="_blank">GitHub</a>
                <a href="https://www.linkedin.com/in/josefbardales/" target="_blank">LinkedIn</a>
            </div>
        </aside>

        <!-- RIGHT MAIN CONTENT -->
        <main class="main-content">
            
            <!-- HEADER SPLIT -->
            <div class="header-split">
                <div class="header-left">
                    <h1 class="page-title">Advanced SQL Analysis in BigQuery</h1>
                    
                    <div class="toc-box">
                        <h3>Table of Contents</h3>
                        <ul>
                            <li><a href="#overview">1. Project Overview</a></li>
                            <li><a href="#cleaning">2. Data Cleaning</a></li>
                            <li><a href="#analysis">3. RFM Analysis</a></li>
                            <li><a href="#window">4. Window Functions</a></li>
                        </ul>
                    </div>
                </div>

                <div class="header-right">
                    <!-- SQL / BigQuery Logo -->
                    <img src="https://allinone-academy.com/images/course/SQL_Academy.png" alt="SQL Logo" class="header-logo">
                </div>
            </div>

            <!-- OVERVIEW -->
            <section id="overview">
                <h2>1. Project Overview</h2>
                <p>
                    In this project, I utilize <strong>Google BigQuery</strong> to perform a comprehensive analysis of e-commerce data. The goal is to move beyond simple data retrieval and demonstrate advanced data manipulation techniques, including <strong>Common Table Expressions (CTEs)</strong>, <strong>Window Functions</strong>, and data cleaning strategies.
                </p>
                <p>
                    The business problem addressed here is calculating <strong>Customer Lifetime Value (CLV)</strong> and segmenting users based on their purchasing behavior (Recency, Frequency, and Monetary value).
                </p>
            </section>

            <!-- DATA CLEANING -->
            <section id="cleaning">
                <h2>2. Data Cleaning & Preparation</h2>
                <p>
                    Real-world data is rarely clean. Before joining tables, I use CTEs to handle <code>NULL</code> values, standardize string formats, and cast data types correctly.
                </p>
                
                <!-- Code Block -->
                <div class="code-block">
<span class="code-comment">-- Step 1: Clean Customer Data using a CTE</span><br>
<span class="code-keyword">WITH</span> CleanCustomers <span class="code-keyword">AS</span> (<br>
&nbsp;&nbsp;<span class="code-keyword">SELECT</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;customer_id,<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-func">COALESCE</span>(email, <span class="code-string">'unknown_email'</span>) <span class="code-keyword">AS</span> email,<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-func">UPPER</span>(<span class="code-func">TRIM</span>(country)) <span class="code-keyword">AS</span> country,<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-func">DATE</span>(created_at) <span class="code-keyword">AS</span> signup_date<br>
&nbsp;&nbsp;<span class="code-keyword">FROM</span> `project.ecommerce.customers`<br>
&nbsp;&nbsp;<span class="code-keyword">WHERE</span> customer_id <span class="code-keyword">IS NOT NULL</span><br>
)
                </div>
                <p>
                    <strong>Why this matters:</strong> Using <code>COALESCE</code> prevents downstream calculation errors, and <code>UPPER(TRIM())</code> ensures that 'USA ', 'usa', and 'USA' are treated as the same country during aggregation.
                </p>
            </section>

            <!-- RFM ANALYSIS -->
            <section id="analysis">
                <h2>3. Joins & RFM Calculation</h2>
                <p>
                    Next, I join the cleaned customer data with the orders table. I perform an aggregate analysis to calculate the three pillars of RFM:
                </p>
                <ul class="list">
                    <li><strong>Recency:</strong> Days since last order.</li>
                    <li><strong>Frequency:</strong> Total count of orders.</li>
                    <li><strong>Monetary:</strong> Total sum of spend.</li>
                </ul>

                <div class="code-block">
<span class="code-comment">-- Step 2: Aggregate Order Data</span><br>
, CustomerStats <span class="code-keyword">AS</span> (<br>
&nbsp;&nbsp;<span class="code-keyword">SELECT</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;c.customer_id,<br>
&nbsp;&nbsp;&nbsp;&nbsp;c.country,<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-func">COUNT</span>(o.order_id) <span class="code-keyword">AS</span> frequency,<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-func">SUM</span>(o.total_amount) <span class="code-keyword">AS</span> monetary,<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-func">MAX</span>(o.order_date) <span class="code-keyword">AS</span> last_order_date<br>
&nbsp;&nbsp;<span class="code-keyword">FROM</span> CleanCustomers c<br>
&nbsp;&nbsp;<span class="code-keyword">INNER JOIN</span> `project.ecommerce.orders` o <br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">ON</span> c.customer_id = o.customer_id<br>
&nbsp;&nbsp;<span class="code-keyword">GROUP BY</span> 1, 2<br>
)
                </div>
            </section>

            <!-- WINDOW FUNCTIONS -->
            <section id="window">
                <h2>4. Advanced Analytics: Window Functions</h2>
                <p>
                    To provide actionable insights, I rank customers within their specific countries based on their total spend. This allows the marketing team to identify the top 5% of customers per region without running separate queries for each country.
                </p>

                <div class="code-block">
<span class="code-comment">-- Step 3: Rank Customers per Country using Window Functions</span><br>
<span class="code-keyword">SELECT</span><br>
&nbsp;&nbsp;customer_id,<br>
&nbsp;&nbsp;country,<br>
&nbsp;&nbsp;monetary,<br>
&nbsp;&nbsp;<span class="code-func">DATE_DIFF</span>(<span class="code-func">CURRENT_DATE</span>(), last_order_date, DAY) <span class="code-keyword">AS</span> recency_days,<br>
&nbsp;&nbsp;<span class="code-func">RANK</span>() <span class="code-keyword">OVER</span> (<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">PARTITION BY</span> country <br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">ORDER BY</span> monetary <span class="code-keyword">DESC</span><br>
&nbsp;&nbsp;) <span class="code-keyword">AS</span> country_rank<br>
<span class="code-keyword">FROM</span> CustomerStats<br>
<span class="code-keyword">WHERE</span> monetary > 0<br>
<span class="code-keyword">ORDER BY</span> country, country_rank <span class="code-keyword">ASC</span>;
                </div>
                
                <p>
                    <strong>Key Insight:</strong> By utilizing <code>PARTITION BY country</code>, the ranking resets for every country. This is far more efficient than using <code>WHERE</code> clauses for every single region. This query produces a clean dataset ready for the marketing team to target "High Value" users who haven't purchased in the last 30 days.
                </p>
            </section>

            <!-- Footer -->
            <div style="margin-top: 60px; border-top: 1px solid #2c3e50; padding-top: 20px; text-align: center;">
                <a href="index.html" class="back-btn" style="font-size: 1rem;">&larr; Return to All Projects</a>
            </div>

        </main>
    </div>

    <!-- VISIT COUNTER SCRIPT (Using CounterAPI.dev) -->
    <script>
        function updateCounter() {
            const counterElement = document.getElementById('visit-count');
            
            // We use a unique namespace + key for your site
            // Namespace: josefbardales
            // Key: portfolio-visits
            const apiUrl = 'https://api.counterapi.dev/v1/josefbardales/portfolio-visits';

            // Check if user visited in this session/browser already
            const hasVisited = localStorage.getItem('hasVisited');

            if (!hasVisited) {
                // NEW VISITOR: Call the 'up' endpoint to increment
                fetch(`${apiUrl}/up`)
                    .then(res => res.json())
                    .then(data => {
                        counterElement.innerText = data.count;
                        localStorage.setItem('hasVisited', 'true');
                    })
                    .catch(err => {
                        console.error("Counter Error:", err);
                        counterElement.innerText = "1"; // Fallback
                    });
            } else {
                // RETURNING VISITOR: Just read the value (no 'up')
                fetch(apiUrl)
                    .then(res => res.json())
                    .then(data => {
                        counterElement.innerText = data.count;
                    })
                    .catch(err => {
                        console.error("Counter Error:", err);
                        counterElement.innerText = "1"; // Fallback
                    });
            }
        }

        document.addEventListener('DOMContentLoaded', updateCounter);
    </script>
</body>
</html>